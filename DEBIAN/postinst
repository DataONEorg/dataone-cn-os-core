#!/bin/bash

LONG_DATE=`date +%Y%m%d%H%M%S`

TOMCAT=tomcat6
TOMCAT_USER=tomcat6
TOMCAT_HOME=/var/lib/tomcat6
SOURCE_DIR=/usr/share/dataone-cn-os-core
SCRIPT_DIR=${SOURCE_DIR}/debian
APACHE_CONF=/etc/apache2
MOD_JK_CONF=/etc/libapache2-mod-jk

##################################################################
# Configure the firewall
##################################################################


ufw default deny
ufw allow ssh
ufw allow http
ufw allow https
ufw enable
echo "Completed configuration of ufw firewall."

##################################################################
# Install the dataone private key provided by the user
# This key can not be added to the SVN repository because it is not
# secure to do so -- access to the file must be restricted
##################################################################
KEY_FILE=${HOME}/dataone_org.key
KEY_DIR=/etc/ssl/private/
if [ -e ${KEY_FILE} ]
then
    echo "Copying private key: ${KEY_FILE}."
    cp ${KEY_FILE} ${KEY_DIR}
else
    echo "Key file is missing.  Please provide it as ${KEY_FILE}. Without
    this, SSL will not function properly."
fi
echo "Completed configuration of private keys."

###############################################################################
# Configure Apache
###############################################################################

## Stop apache
echo "Stopping Apache"
/etc/init.d/apache2 stop
## copy in jk.conf file
if [ -e ${APACHE_CONF}/mods-available/jk.conf ]
then 
  JK_CONF_DIFF=`diff ${SCRIPT_DIR}/jk.conf ${APACHE_CONF}/mods-available/jk.conf`
  if [ "${JK_CONF_DIFF}" != "" ]
  then
    echo "Backing up ${APACHE_CONF}/mods-available/jk.conf to ${APACHE_CONF}/mods-available/jk.conf.${LONG_DATE}"
    mv ${APACHE_CONF}/mods-available/jk.conf ${APACHE_CONF}/mods-available/jk.conf.${LONG_DATE}
  fi
fi
echo "Copying jk.conf to ${APACHE_CONF}/mods-available/"
cp ${SCRIPT_DIR}/jk.conf ${APACHE_CONF}/mods-available/

## copy in workers.properties file for mod-jk
if [ -e ${MOD_JK_CONF}/workers.properties ]
then 
  WORKERS_PROPS_DIFF=`diff ${SCRIPT_DIR}/workers.properties ${MOD_JK_CONF}/workers.properties`
  if [ "${WORKERS_PROPS_DIFF}" != "" ]
  then
    echo "Backing up ${MOD_JK_CONF}/workers.properties to ${MOD_JK_CONF}/workers.properties.${LONG_DATE}"
    mv ${MOD_JK_CONF}/workers.properties ${MOD_JK_CONF}/workers.properties.${LONG_DATE}
  fi
fi
echo "Copying workers.properties to ${MOD_JK_CONF}/"
cp ${SCRIPT_DIR}/workers.properties ${MOD_JK_CONF}/

## disable and then re-enable mod jk to pick up changes
echo "Refreshing Mod JK"
a2dismod jk
a2enmod jk


## disable the default apache site, which gets in the way of the other sites
a2dissite 000-default
## Start Apache
/etc/init.d/apache2 start

## Stop tomcat
echo "Stopping Tomcat"
/etc/init.d/${TOMCAT} stop

## copy in jk.conf file
if [ -e ${TOMCAT_HOME}/conf/server.xml ]
then 
  JK_CONF_DIFF=`diff ${SCRIPT_DIR}/server.xml ${TOMCAT_HOME}/conf/server.xml`
  if [ "${JK_CONF_DIFF}" != "" ]
  then
    echo "Backing up ${TOMCAT_HOME}/conf/server.xml to ${TOMCAT_HOME}/conf/server.xml.${LONG_DATE}"
    mv ${TOMCAT_HOME}/conf/server.xml ${TOMCAT_HOME}/conf/server.xml.${LONG_DATE}
  fi
fi
echo "Copying server.xml to ${TOMCAT_HOME}/conf/"
cp ${TOMCAT_HOME}/server.xml ${TOMCAT_HOME}/conf/


chown -R ${TOMCAT_USER}.${TOMCAT_USER} /etc/tomcat6
chown -R ${TOMCAT_USER}.${TOMCAT_USER} /var/lib/tomcat6
chown -R ${TOMCAT_USER}.${TOMCAT_USER} /var/log/tomcat6
chown -R ${TOMCAT_USER}.${TOMCAT_USER} /var/cache/tomcat6
chown -R ${TOMCAT_USER}.${TOMCAT_USER} /usr/share/tomcat6

## Start Tomcat
echo "starting Tomcat server"

/etc/init.d/${TOMCAT} start

echo "Configuration of OS complete."
